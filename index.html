<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste cadeaux â€” NoÃ«l & Anniversaire</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .row-checked{filter:grayscale(1); opacity:.55}
    .pretty-card{background:linear-gradient(180deg,#fff, #fafbfd); box-shadow:0 4px 22px rgba(2,6,23,.08)}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:9999px;font-size:.72rem;background:#eef2ff;color:#3730a3}
  </style>
  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto p-6">
    <header class="flex items-center justify-between gap-4">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold">ğŸ Liste de cadeaux â€” NoÃ«l & Anniversaire</h1>
        <p class="text-slate-600">Partage le lien. Chacun coche ou clique sur le lien, point barre.</p>
      </div>
      <div class="hidden md:block">
        <span class="pill">Synchronisation en direct</span>
      </div>
    </header>

    <!-- Filtres minimalistes -->
    <section class="mt-6 pretty-card rounded-2xl p-4">
      <div class="flex flex-wrap items-center gap-2">
        <select id="filterCategory" class="border rounded-lg px-3 py-2">
          <option value="">Toutes catÃ©gories</option>
          <option value="NoÃ«l">NoÃ«l</option>
          <option value="Anniversaire">Anniversaire</option>
        </select>
        <select id="filterReserved" class="border rounded-lg px-3 py-2">
          <option value="all">Tous</option>
          <option value="no">Non cochÃ©s</option>
          <option value="yes">CochÃ©s</option>
        </select>
        <input id="filterSearch" class="border rounded-lg px-3 py-2 flex-1 min-w-[200px]" placeholder="Rechercher un jouetâ€¦" />
        <span class="text-sm text-slate-500" id="counter"></span>
      </div>
    </section>

    <!-- Liste -->
    <section class="mt-6 pretty-card rounded-2xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="text-left px-4 py-3 w-12">OK</th>
              <th class="text-left px-4 py-3">Nom du jouet</th>
              <th class="text-left px-4 py-3">Prix</th>
              <th class="text-left px-4 py-3">Magasin(s) alternatif(s)</th>
              <th class="text-left px-4 py-3">CatÃ©gorie</th>
              <th class="text-left px-4 py-3 w-10"></th>
            </tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-xs text-slate-500 mt-6 text-center">
      <p>Astuce : tu peux crÃ©er plusieurs listes avec l'URL, ex. <code>?list=noel</code> et <code>?list=anniv</code>.</p>
    </footer>
  </div>

  <!-- Bouton + flottant -->
  <button id="fab" class="fixed bottom-5 right-5 rounded-full w-14 h-14 flex items-center justify-center text-white text-2xl shadow-xl bg-slate-900 hover:bg-slate-800" title="Ajouter un cadeau">ï¼‹</button>

  <!-- Modal ajout -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-end sm:items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-xl p-5 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Ajouter un cadeau</h2>
        <button id="closeModal" class="text-slate-400 hover:text-slate-700">âœ•</button>
      </div>
      <form id="addForm" class="grid grid-cols-1 gap-3">
        <input required name="name" class="border rounded-lg px-3 py-2" placeholder="Nom du jouet" />
        <input name="price" class="border rounded-lg px-3 py-2" placeholder="Prix (ex: 29,99â‚¬)" />
        <input name="url" type="url" class="border rounded-lg px-3 py-2" placeholder="Lien vers le produit (URL)" />
        <input name="alts" class="border rounded-lg px-3 py-2" placeholder="Autres magasins (sÃ©parÃ©s par des virgules)" />
        <select name="category" class="border rounded-lg px-3 py-2"><option>NoÃ«l</option><option>Anniversaire</option></select>
        <div class="flex gap-2 justify-end mt-2">
          <button type="button" id="cancelAdd" class="px-4 py-2 rounded-lg border">Annuler</button>
          <button class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" type="submit">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- Firebase config (dÃ©jÃ  personnalisÃ©e) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAvUXd1GMRaPf0IQYk9wFikRZWMm-Z3v_Y",
      authDomain: "listecadeaux-86625.firebaseapp.com",
      databaseURL: "https://listecadeaux-86625-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "listecadeaux-86625",
      storageBucket: "listecadeaux-86625.appspot.com",
      messagingSenderId: "129398815279",
      appId: "1:129398815279:web:3910f8f8f7090062c3d7821a"
    };

    const params = new URLSearchParams(location.search);
    const LIST_ID = params.get('list') || 'liste-principale';

    // Init Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rootRef = db.ref(`giftlists/${LIST_ID}/items`);

    // UI refs
    const tbody = document.getElementById('tbody');
    const filterCategory = document.getElementById('filterCategory');
    const filterReserved = document.getElementById('filterReserved');
    const filterSearch = document.getElementById('filterSearch');
    const counter = document.getElementById('counter');

    const modal = document.getElementById('modal');
    const fab = document.getElementById('fab');
    const closeModal = document.getElementById('closeModal');
    const cancelAdd = document.getElementById('cancelAdd');
    const addForm = document.getElementById('addForm');

    fab.onclick = ()=> modal.classList.remove('hidden');
    closeModal.onclick = cancelAdd.onclick = ()=> modal.classList.add('hidden');

    let allItems = {};

    function render(){
      const cat = filterCategory.value;
      const res = filterReserved.value; // all | yes | no
      const q = filterSearch.value.toLowerCase().trim();
      const entries = Object.entries(allItems).map(([id,x])=>({id, ...x}))
        .sort((a,b)=> (a.reserved===true) - (b.reserved===true) || (a.name||'').localeCompare(b.name||''));

      tbody.innerHTML = '';
      let visible=0, total=entries.length, totalReserved=0;

      for(const it of entries){
        if (cat && it.category !== cat) continue;
        if (res==='yes' && !it.reserved) continue;
        if (res==='no' && it.reserved) continue;
        const hay = `${it.name||''} ${it.price||''} ${it.alts||''} ${it.category||''}`.toLowerCase();
        if (q && !hay.includes(q)) continue;
        visible++; if (it.reserved) totalReserved++;

        const tr = document.createElement('tr');
        tr.className = it.reserved ? 'row-checked' : '';

        // checkbox
        const td0 = document.createElement('td');
        td0.className='px-4 py-3 align-top';
        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.checked = !!it.reserved;
        cb.addEventListener('change',()=>toggleReserved(it.id));
        td0.appendChild(cb);

        // name + link
        const td1 = document.createElement('td');
        td1.className='px-4 py-3 align-top';
        const nameLink = document.createElement('a');
        nameLink.className='font-semibold hover:underline';
        nameLink.target='_blank'; nameLink.rel='noopener';
        nameLink.textContent = it.name || '(sans nom)';
        nameLink.href = it.url || 'javascript:void(0)';
        td1.appendChild(nameLink);
        if (it.url){
          const urlSmall = document.createElement('div');
          urlSmall.className='text-xs text-slate-500 truncate max-w-[420px]';
          urlSmall.textContent = it.url; td1.appendChild(urlSmall);
        }

        const td2 = document.createElement('td'); td2.className='px-4 py-3 align-top'; td2.textContent = it.price || '';

        const td3 = document.createElement('td'); td3.className='px-4 py-3 align-top';
        if (it.alts){
          const parts = it.alts.split(',').map(s=>s.trim()).filter(Boolean);
          const ul = document.createElement('ul'); ul.className='list-disc ml-5';
          for(const p of parts){
            const li=document.createElement('li');
            if (/^https?:\/\//i.test(p)){ const a=document.createElement('a'); a.href=p; a.target='_blank'; a.rel='noopener'; a.className='hover:underline'; a.textContent=p; li.appendChild(a);} else { li.textContent=p; }
            ul.appendChild(li);
          }
          td3.appendChild(ul);
        }

        const td4 = document.createElement('td'); td4.className='px-4 py-3 align-top'; td4.textContent = it.category || '';

        const td5 = document.createElement('td'); td5.className='px-4 py-3 align-top';
        const del = document.createElement('button'); del.className='text-slate-400 hover:text-red-600'; del.title='Supprimer'; del.textContent='âœ•';
        del.addEventListener('click',()=>{ if(confirm('Supprimer cet Ã©lÃ©ment ?')) rootRef.child(it.id).remove(); });
        td5.appendChild(del);

        tr.append(td0,td1,td2,td3,td4,td5);
        tbody.appendChild(tr);
      }
      counter.textContent = `${visible} affichÃ©(s) / ${total} â€” ${totalReserved} cochÃ©(s)`;
    }

    function toggleReserved(id){
      const it = allItems[id]; if (!it) return;
      const now = !it.reserved;
      rootRef.child(id).update({ reserved: now, reservedAt: now ? Date.now() : null });
    }

    // Add item (via modal)
    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(addForm);
      const data = {
        name: (fd.get('name')||'').toString().trim(),
        price: (fd.get('price')||'').toString().trim(),
        url: (fd.get('url')||'').toString().trim(),
        alts: (fd.get('alts')||'').toString().trim(),
        category: fd.get('category')||'NoÃ«l',
        reserved: false,
        createdAt: Date.now()
      };
      rootRef.push().set(data).then(()=>{
        addForm.reset(); modal.classList.add('hidden');
      });
    });

    // Filtres
    for (const el of [filterCategory, filterReserved, filterSearch]) el.addEventListener('input', render);

    // Live listeners (fiables)
    rootRef.on('value', snap => {
      const val = snap.val() || {};
      // copiÃ© proprement (Ã©vite propriÃ©tÃ© interne path.pieces_ vu sur certaines versions)
      allItems = {};
      Object.keys(val).forEach(id => allItems[id] = { id, ...val[id] });
      render();
    });
  </script>
</body>
</html>
