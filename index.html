<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Liste cadeaux ‚Äî No√´l & Anniversaire</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{ --navy:#0b1f3a; --navy-2:#09223f; }
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}

    /* Fond bleu + dinos */
    body{ background:#0b1f3a url('bg-dinos.png') repeat fixed; background-size:700px auto; }

    /* Cartes / filtres */
    .pretty{
      background:linear-gradient(135deg,var(--navy-2),var(--navy));
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      border-radius:22px;
    }
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.22);
      color:#e6edff;
      padding:.65rem 1rem;
      border-radius:9999px;
      backdrop-filter:blur(6px)
    }
    .pill::placeholder{color:#cbd5ff99}
    .pill:focus{outline:none; box-shadow:0 0 0 3px rgba(230,237,255,.18); border-color:#cbd5ff80}
    select.pill{
      appearance:none;-webkit-appearance:none;
      background-image:linear-gradient(45deg,transparent 50%, #cbd5ff 50%),linear-gradient(135deg,#cbd5ff 50%,transparent 50%);
      background-position:calc(100% - 18px) 52%, calc(100% - 12px) 52%;
      background-size:6px 6px;background-repeat:no-repeat;padding-right:2.2rem
    }

    /* Tableau navy */
    .table-wrap{border-radius:20px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    thead.navy{background:linear-gradient(135deg,var(--navy-2),var(--navy)); color:#fff}
    tbody.navy tr{background:rgba(255,255,255,.14)}           /* fond unique (pas d‚Äôalternance) */
    tbody.navy td{color:#eaf1ff}
    .row-checked{filter:grayscale(1); opacity:.55}

    /* Lien produit mis en avant (soulign√©, pas gras) */
    tbody.navy a.name{
      color:#cfe1ff; text-decoration:underline; text-underline-offset:2px; text-decoration-thickness:2px
    }
    tbody.navy a.name:hover{opacity:.9}

    /* Magasins (chips) */
    ul.stores{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.4rem}
    ul.stores li{background:rgba(255,255,255,.18);color:#e6edff;border-radius:9999px;padding:.28rem .6rem;list-style:none}
    ul.stores li a{color:#e9f1ff}

    /* Desktop (tableau natif) */
    table thead{display:table-header-group}
    tbody.navy tr{display:table-row}
    tbody.navy td{display:table-cell; padding:.75rem 1rem; vertical-align:top}

	/* DESKTOP ‚Äî traits entre les lignes du tableau */
	@media (min-width: 601px){
	  .table-wrap tbody tr td{
		border-bottom: 1px solid rgba(255,255,255,.12); /* m√™me teinte que mobile */
	  }
	  .table-wrap tbody tr:last-child td{
		border-bottom: 0; /* pas de trait sous la derni√®re ligne */
	  }
	}

    /* ---------- MOBILE : L1 = [OK][Nom][Prix] ; L2 = magasins full-width ---------- */
    @media (max-width: 600px){
      .table-wrap{
        display:block; width:100%; overflow:hidden; --row-pad:12px;
      }
      .table-wrap table,.table-wrap thead,.table-wrap tbody{display:block}

      /* Ent√™te : 3 colonnes */
      .table-wrap thead tr{
        display:grid; grid-template-columns:44px minmax(0,1fr) min-content;
        gap:8px 12px; padding:12px; align-items:center;
      }
      .table-wrap thead th:nth-child(4){display:none}

      /* L1 */
      .table-wrap tbody tr.rowA{
        position:relative;
        display:grid;
        grid-template-columns:44px minmax(0,1fr) min-content;
        gap:8px 12px; padding:14px var(--row-pad); box-sizing:border-box;
        background:rgba(255,255,255,.14) !important;         /* m√™me fond que L2 */
        border-bottom:0 !important;

        /* full-bleed */
        margin-left:calc(-1*var(--row-pad));
        margin-right:calc(-1*var(--row-pad));
        width:calc(100% + (2*var(--row-pad)));
      }
      .table-wrap tbody tr.rowA > td{background:transparent !important}
      .table-wrap tbody tr.rowA td[data-label="OK"]{display:flex; align-items:flex-start}
      .table-wrap tbody tr.rowA td[data-label="Prix"]{text-align:right; white-space:nowrap; font-weight:700}
      .table-wrap tbody tr.rowA a.name{display:inline-block; word-break:break-word}

      /* Croix */
      .table-wrap tbody tr.rowA td.cell-actions{
        position:absolute; right:20px; top:2px; display:block; padding:0; margin:0;
      }

      /* L2 : ligne magasins, m√™me largeur & fond, full-bleed */
      .table-wrap tbody tr.rowB{
        display:block;
        background:rgba(255,255,255,.14) !important;
        margin-left:calc(-0*var(--row-pad));
        margin-right:calc(-0*var(--row-pad));
        width:calc(100% + (1*var(--row-pad)));
        border-top:1px solid rgba(255,255,255,.10);
        border-bottom:1px solid rgba(255,255,255,.10);
      }
      .table-wrap tbody tr.rowB .stores-cell{padding:8px var(--row-pad) 14px}

      .table-wrap tbody tr.rowB ul.stores{
        list-style:none; margin:.35rem 0 0 0; padding:0; display:flex; flex-wrap:wrap; gap:.45rem; width:100%; min-width:0;
      }
    }
  </style>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
    // (Optionnel) forcer l‚Äôaper√ßu mobile avec ?mobile=1
    function applyMobileMode(){
      const qp = new URLSearchParams(location.search);
      const force = qp.get('mobile');
      const on = force==='1' ? true : (force==='0'? false : (window.innerWidth<=600));
      document.body.classList.toggle('is-mobile', on);
    }
    window.addEventListener('resize', applyMobileMode);
    document.addEventListener('DOMContentLoaded', applyMobileMode);
  </script>
</head>

<body class="min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <!-- Header -->
    <header class="pretty p-6 md:p-7">
      <h1 class="text-2xl md:text-3xl font-extrabold">ü¶ñ No√´l & Anniversaire de Matteo</h1>
      <p class="text-white/85">Une petite liste d'id√©es de cadeaux pour Matteo (15 d√©cembre). üêæ<br>
      Si jamais vous √™tes inspirez niveau shopping il fait du 98 cm ~3ans dans la plupart des magasins.<br>
      Si vous trouvez une id√©e dans la liste h√©sitez pas √† cocher la case pour qu'on ach√®te pas plusieurs fois la m√™me chose.</p>
    </header>

    <!-- Filtres -->
    <section class="pretty p-4 mt-6">
      <div class="flex flex-wrap items-center gap-3">
        <select id="filterReserved" class="pill">
          <option value="all">Tous</option>
          <option value="no">Non coch√©s</option>
          <option value="yes">Coch√©s</option>
        </select>
        <input id="filterSearch" class="pill flex-1 min-w-[220px]" placeholder="Rechercher un jouet‚Ä¶" />
        <span class="text-sm text-white/80" id="counter"></span>
      </div>
    </section>

    <!-- Tableau -->
    <section class="mt-6 table-wrap">
      <table class="min-w-full text-sm">
        <thead class="navy">
          <tr>
            <th class="text-left px-4 py-3 w-12">OK</th>
            <th class="text-left px-4 py-3">Id√©e</th>
            <th class="text-left px-4 py-3">Prix</th>
            <th class="text-left px-4 py-3 w-10"></th>
          </tr>
        </thead>
        <tbody id="tbody" class="navy"></tbody>
      </table>
      <div id="emptyState" class="text-center text-white/90 py-10 hidden">Rien √† afficher pour le moment.</div>
    </section>
  </div>

  <!-- Bouton + -->
  <button id="fab" class="fixed bottom-5 right-5 z-50 rounded-full w-14 h-14 flex items-center justify-center text-white text-2xl shadow-2xl" style="background:var(--navy);">Ôºã</button>

  <!-- Modal ajout -->
  <div id="modal" class="fixed inset-0 bg-black/60 hidden flex items-end sm:items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl w-full max-w-xl p-5 shadow-xl">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Ajouter un cadeau</h2>
        <button id="closeModal" class="text-slate-400 hover:text-slate-700" aria-label="Fermer">‚úï</button>
      </div>
      <form id="addForm" class="grid grid-cols-1 gap-3">
        <input required name="name" class="border rounded-lg px-3 py-2" placeholder="Nom du jouet" />
        <input name="price" class="border rounded-lg px-3 py-2" placeholder="Prix (ex: 29,99‚Ç¨)" />
        <input name="url" type="url" class="border rounded-lg px-3 py-2" placeholder="Lien vers le produit (URL)" />
        <input name="alts" class="border rounded-lg px-3 py-2" placeholder="Autres magasins (s√©par√©s par des virgules)" />
        <div class="flex gap-2 justify-end mt-2">
          <button type="button" id="cancelAdd" class="px-4 py-2 rounded-lg border">Annuler</button>
          <button class="px-4 py-2 rounded-lg bg-slate-900 text-white hover:bg-slate-800" type="submit">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyAvUXd1GMRaPf0IQYk9wFikRZWMm-Z3v_Y",
      authDomain: "listecadeaux-86625.firebaseapp.com",
      databaseURL: "https://listecadeaux-86625-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "listecadeaux-86625",
      storageBucket: "listecadeaux-86625.appspot.com",
      messagingSenderId: "129398815279",
      appId: "1:129398815279:web:3910f8f8f7090062c3d7821a"
    };
    const LIST_ID = new URLSearchParams(location.search).get('list') || 'liste-principale';

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rootRef = db.ref(`giftlists/${LIST_ID}/items`);

    // UI refs
    const tbody = document.getElementById('tbody');
    const filterReserved = document.getElementById('filterReserved');
    const filterSearch = document.getElementById('filterSearch');
    const counter = document.getElementById('counter');
    const emptyState = document.getElementById('emptyState');
    const modal = document.getElementById('modal');
    const fab = document.getElementById('fab');
    const closeModalBtn = document.getElementById('closeModal');
    const cancelAdd = document.getElementById('cancelAdd');
    const addForm = document.getElementById('addForm');

    // Modal
    const openModal = ()=> modal.classList.remove('hidden');
    const closeModal = ()=> modal.classList.add('hidden');
    fab.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    cancelAdd.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

    let allItems = {};

    function render(){
      const res = filterReserved.value; // all | yes | no
      const q = filterSearch.value.toLowerCase().trim();

      const entries = Object.entries(allItems).map(([id,x])=>({id, ...x}))
        .sort((a,b)=> (a.reserved===true) - (b.reserved===true) || (a.name||'').localeCompare(b.name||''));

      tbody.innerHTML = '';
      let visible=0, total=entries.length, totalReserved=0;

      for (const it of entries){
        if (res==='yes' && !it.reserved) continue;
        if (res==='no' && it.reserved) continue;
        const hay = `${it.name||''} ${it.price||''} ${it.alts||''}`.toLowerCase();
        if (q && !hay.includes(q)) continue;

        visible++; if (it.reserved) totalReserved++;

        /* L1 : OK | Nom | Prix | croix */
        const trA = document.createElement('tr');
        trA.className = (it.reserved ? 'row-checked ' : '') + 'rowA';

        const td0 = document.createElement('td');
        td0.className='px-4 py-3 align-top'; td0.setAttribute('data-label','OK');
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.checked=!!it.reserved;
        cb.addEventListener('change',()=>toggleReserved(it.id));
        td0.appendChild(cb);

        const td1 = document.createElement('td');
        td1.className='px-4 py-3 align-top'; td1.setAttribute('data-label','Nom');
        const nameLink = document.createElement('a');
        nameLink.className='name hover:opacity-90 block';
        nameLink.target='_blank'; nameLink.rel='noopener';
        nameLink.textContent = it.name || '(sans nom)';
        nameLink.href = it.url || 'javascript:void(0)';
        td1.appendChild(nameLink);

        const td2 = document.createElement('td');
        td2.className='px-4 py-3 align-top'; td2.setAttribute('data-label','Prix');
        td2.textContent = it.price || '';

        const td3 = document.createElement('td');
        td3.className='px-4 py-3 align-top cell-actions';
        const del = document.createElement('button');
        del.className='text-slate-300 hover:text-red-500'; del.title='Supprimer'; del.textContent='‚úï';
        del.addEventListener('click',()=>{ if(confirm('Supprimer cet √©l√©ment ?')) rootRef.child(it.id).remove(); });
        td3.appendChild(del);

        trA.append(td0, td1, td2, td3);
        tbody.appendChild(trA);

        /* L2 : magasins sur toute la largeur (colspan) */
        const stores = (it.alts||'').split(',').map(s=>s.trim()).filter(Boolean);
        if (stores.length){
          const trB = document.createElement('tr');
          trB.className = (it.reserved ? 'row-checked ' : '') + 'rowB';

          const tdStores = document.createElement('td');
          tdStores.className = 'stores-cell px-4 py-2';
          tdStores.colSpan = 4;

          const ul = document.createElement('ul'); ul.className='stores';
          for (const p of stores){
            const li = document.createElement('li');
            li.className = 'chip';
            if (/^https?:\/\//i.test(p)){
              const a = document.createElement('a');
              a.href=p; a.target='_blank'; a.rel='noopener'; a.className='hover:underline'; a.textContent=p;
              li.appendChild(a);
            } else {
              li.textContent = p;
            }
            ul.appendChild(li);
          }
          tdStores.appendChild(ul);
          trB.appendChild(tdStores);
          tbody.appendChild(trB);
        }
      }

      counter.textContent = `${visible} affich√©(s) / ${total} ‚Äî ${totalReserved} coch√©(s)`;
      emptyState.classList.toggle('hidden', visible !== 0);
    }

    function toggleReserved(id){
      const it = allItems[id]; if (!it) return;
      const now = !it.reserved;
      rootRef.child(id).update({ reserved: now, reservedAt: now ? Date.now() : null });
    }

    // Ajout
    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(addForm);
      const data = {
        name: (fd.get('name')||'').toString().trim(),
        price: (fd.get('price')||'').toString().trim(),
        url:   (fd.get('url')||'').toString().trim(),
        alts:  (fd.get('alts')||'').toString().trim(),
        reserved: false,
        createdAt: Date.now()
      };
      rootRef.push().set(data)
        .then(()=>{ addForm.reset(); closeModal(); })
        .catch(err=> alert('Ajout impossible : ' + (err?.message || err)));
    });

    // Filtres
    for (const el of [filterReserved, filterSearch]) el.addEventListener('input', render);

    // Live
    rootRef.on('value', snap => {
      const val = snap.val() || {};
      allItems = {}; Object.keys(val).forEach(id => allItems[id] = { id, ...val[id] });
      render();
    }, err => alert('Connexion Firebase √©chou√©e : ' + (err?.message || err)));
  </script>
</body>
</html>
